<html>
	<head>
		<title>Distance/Time To Action</title>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"></script>
		<!--link type="text/css" rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"-->
		<script type="text/javascript">
		Number.prototype.toRad = function() {
			return this * Math.PI / 180;
		}

		function postMessage(msg) {
			document.getElementById("message").innerHTML = msg;
		}

		function postDebugMessage(msg) {
			debugMsgIdx++;
			document.getElementById("debug-message").innerHTML += "<br>" + debugMsgIdx + ": " + msg;
		}

		function getLocation(index) {
			postDebugMessage('getlocation' + index);
			if (index && navigator.geolocation) {
				currentIndex = index;
				navigator.geolocation.getCurrentPosition(showPosition);
			} else {
				document.getElementById("message").innerHTML = "Geolocation is not supported by your browser";
			}
		}

		function showPosition(position) {
			postDebugMessage(position.coords.latitude + "," + position.coords.longitude);

			var loc = $("#location"+currentIndex+"-coordinates span")[0];
			loc.innerHTML = position.coords.latitude + ", " + position.coords.longitude;

			var ts = $("#location"+currentIndex+"-timestamp span")[0];
			var timestamp = moment();
			ts.innerHTML = timestamp.format("DD MMMM YYYY, HH:mm:ss");

			locations[currentIndex] = [position, timestamp];
		}

		function calculateDistance(pos1, pos2) {
			var R = 6371; //km
			var dLat = (pos2.coords.latitude - pos1.coords.latitude).toRad();
			var dLng = (pos2.coords.longitude - pos1.coords.longitude).toRad();
			var lat1 = pos1.coords.latitude.toRad();
			var lat2 = pos2.coords.latitude.toRad();

			var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLng/2) * Math.sin(dLng/2) * Math.cos(lat1) * Math.cos(lat2); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			return R * c;
		}

		function calculate() {
			var distance = calculateDistance(locations[1][0], locations[2][0]);
			var readableDistance = distance.toString().split('.');
			readableDistance[1] = readableDistance[1].substring(0, 3);
			$("#time-to-action #distance span")[0].innerHTML = readableDistance.join('.') + " KM";
			postDebugMessage("distance diff in km: " + distance);

			//ts2 is irrelevant
			// formula : ts1 + actual time needed to go the distance at xx kmph
			var originTime = locations[1][1];
			var speed = $("#speed")[0].value;
			var timeNeeded = Math.ceil(distance / speed * 60 * 60 * 1000); // in miliseconds
			var destination = moment(originTime); //clone moment obj
			destination.add("ms", timeNeeded);
			$("#time-to-action #estimated-time span")[0].innerHTML = destination.format('DD MMMM YYYY, HH:mm:ss') + 
			" (" + destination.from(originTime) + ", " + destination.diff(originTime, 'minutes', true) + ")";

			postDebugMessage("time diff in ms: " + destination.diff(originTime));
                        postDebugMessage("origin: " + originTime.format());
                        postDebugMessage("destination: " + destination.format());
                        postDebugMessage("timeneeded: " + timeNeeded);
		}


		var currentIndex = 0, debugMsgIdx = 0;
		var locations = [];
		</script>

		<style type="text/css">
		#container {			
			margin: 0 auto;
		}
		button, select {
			font-size: 1.8em;
			padding: 10px 35px;
		}
		</style>
	</head>
	<body>
		<div id="container">
			<h1>Location/Time to Action</h1>
			<div id="message"></div>
			<div>
				<h2>Origin</h2>
				<button type="button" id="btn-location1" onClick="javascript:getLocation(1)">Get Location</button>
				<div id="location1">
					<div id="location1-coordinates" class="coordinates">Location: <span></span></div>
					<div id="location1-timestamp" class="timestamp">Timestamp: <span></span></div>
				</div>
			</div>
			<div>
				<h2>Destination</h2>
				<button type="button" id="btn-location2" onClick="javascript:getLocation(2)">Get Location</button>
				<div id="location2">
					<div id="location2-coordinates" class="coordinates">Location: <span></span></div>
					<div id="location2-timestamp" class="timestamp">Timestamp: <span></span></div>
				</div>
			</div>
			<div>
				<h2>Speed (KM)</h2>
				<select id="speed">
					<option value="20">20KM/h</option>
					<option value="40">40KM/h</option>
					<option value="60" selected>60KM/h</option>
					<option value="80">80KM/h</option>
					<option value="100">100KM/h</option>
				</select>
			</div>
			<div>
				<h2>Time to Action</h2>
				<button type="button" id="calculate-time" onClick="javascript:calculate()">Calculate</button>
				<div id="time-to-action">
					<div id="distance">Distance: <span></span></div>
					<div id="estimated-time">Estimated arrival to Destination: <br><span></span></div>
				</div>
			</div>

			<div id="debug-message"></div>
		</div>
	</body>
</html>
